<!DOCTYPE html>
<html class="light" lang="fi">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title><%= title %></title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <script>
      tailwind.config = {
          darkMode: "class",
          theme: {
              extend: {
                  colors: {
                      "primary": "#0b73da",
                      "background-light": "#f5f7f8",
                      "background-dark": "#101922",
                  },
                  fontFamily: {
                      "display": ["Inter", "sans-serif"]
                  },
                  borderRadius: {
                      "DEFAULT": "0.25rem",
                      "lg": "0.5rem",
                      "xl": "0.75rem",
                      "full": "9999px"
                  },
              },
          },
      }
  </script>
  <style>.material-symbols-outlined{font-variation-settings:'FILL' 0,'wght' 400,'GRAD' 0,'opsz' 24}</style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-[#0d141c] dark:text-white">
<div class="flex min-h-screen">
  <%- include("components/sidebar") %>
  <main class="flex-1 p-8">
<div class="flex flex-wrap justify-between gap-3 mb-8">
<div class="flex min-w-72 flex-col gap-2">
<h1 class="text-4xl font-black leading-tight tracking-[-0.033em] text-[#0d141c] dark:text-white">Yleiskatsaus</h1>
<p class="text-base font-normal leading-normal text-slate-500 dark:text-slate-400">Yleiskatsaus organisaation repositoryistä.</p>
</div>
<div class="flex items-center gap-3">
<button id="refresh-btn" onclick="refreshData()" class="flex items-center gap-2 px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
<span class="material-symbols-outlined text-sm">refresh</span>
<span class="text-sm font-medium">Päivitä tiedot</span>
</button>
<div id="refresh-status" class="hidden flex items-center gap-2 text-sm text-slate-500">
<span class="material-symbols-outlined animate-spin">refresh</span>
<span>Päivitetään...</span>
</div>
</div>
</div>
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
<div class="flex flex-col gap-2 rounded-xl p-6 border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900">
<p class="text-base font-medium leading-normal text-[#0d141c] dark:text-slate-300">Yhteensä repositoryt</p>
<p class="tracking-light text-3xl font-bold leading-tight text-[#0d141c] dark:text-white"><%= totalRepos %></p>
<p class="text-sm font-medium leading-normal text-green-600">Aktiivinen</p>
</div>
<div class="flex flex-col gap-2 rounded-xl p-6 border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900">
<p class="text-base font-medium leading-normal text-[#0d141c] dark:text-slate-300">Eniten käytetty kieli</p>
<p class="tracking-light text-3xl font-bold leading-tight text-[#0d141c] dark:text-white">
<% 
let dominantLanguage = 'Unknown';
let maxCount = 0;
Object.entries(languageCounts).forEach(([lang, count]) => {
    if (count > maxCount) {
        maxCount = count;
        dominantLanguage = lang;
    }
});
%>
<%= dominantLanguage %>
</p>
<p class="text-sm font-medium leading-normal text-slate-500 dark:text-slate-400"><%= maxCount %> repositoryä</p>
</div>
<div class="flex flex-col gap-2 rounded-xl p-6 border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900">
<p class="text-base font-medium leading-normal text-[#0d141c] dark:text-slate-300">Eri kieliä</p>
<p class="tracking-light text-3xl font-bold leading-tight text-[#0d141c] dark:text-white">
<%= Object.keys(languageCounts).length %>
</p>
<p class="text-sm font-medium leading-normal text-slate-500 dark:text-slate-400">Kielityyppiä</p>
</div>
</div>
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
<div class="flex flex-col gap-4 rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 p-6">
<h2 class="text-[#0d141c] dark:text-white text-lg font-semibold leading-normal">Kielijakauma</h2>
<div class="flex justify-center items-center h-full relative">
<svg class="w-64 h-64" viewBox="0 0 200 200">
<%
// Calculate pie chart data
let totalLangCount = 0;
Object.values(languageCounts).forEach(count => totalLangCount += count);

let currentAngle = 0;
const colors = {
  'PHP': '#777bb4',
  'JavaScript': '#f7df1e', 
  'Python': '#3776ab',
  'Java': '#ed8b00',
  'TypeScript': '#3178c6',
  'Go': '#00add8',
  'C#': '#239120',
  'Ruby': '#cc342d',
  'Swift': '#fa7343',
  'Kotlin': '#7f52ff',
  'Rust': '#dea584',
  'C++': '#00599c',
  'C': '#a8b9cc',
  'Shell': '#89e051',
  'HTML': '#e34c26',
  'CSS': '#1572b6',
  'Vue': '#4fc08d',
  'Angular': '#dd0031',
  'Svelte': '#ff3e00',
  'Other': '#6c757d'
};

// Sort languages by count (descending)
const sortedLanguages = Object.entries(languageCounts)
  .sort(([,a], [,b]) => b - a)
  .slice(0, 8); // Show top 8 languages

sortedLanguages.forEach(([lang, count]) => {
  const percentage = (count / totalLangCount) * 100;
  const angle = (percentage / 100) * 360;
  const radius = 80;
  const centerX = 100;
  const centerY = 100;
  
  const startAngle = currentAngle;
  const endAngle = currentAngle + angle;
  
  const startAngleRad = (startAngle - 90) * Math.PI / 180;
  const endAngleRad = (endAngle - 90) * Math.PI / 180;
  
  const x1 = centerX + radius * Math.cos(startAngleRad);
  const y1 = centerY + radius * Math.sin(startAngleRad);
  const x2 = centerX + radius * Math.cos(endAngleRad);
  const y2 = centerY + radius * Math.sin(endAngleRad);
  
  const largeArcFlag = angle > 180 ? 1 : 0;
  
  const pathData = [
    `M ${centerX} ${centerY}`,
    `L ${x1} ${y1}`,
    `A ${radius} ${radius} 0 ${largeArcFlag} 1 ${x2} ${y2}`,
    'Z'
  ].join(' ');
  
  const color = colors[lang] || colors['Other'];
%>
<path d="<%= pathData %>" fill="<%= color %>" stroke="white" stroke-width="2" opacity="0.9"/>
<%
  currentAngle += angle;
});
%>
</svg>
</div>
<div class="grid grid-cols-2 gap-x-6 gap-y-2 mt-4 text-sm">
<% sortedLanguages.forEach(([lang, count]) => { %>
<div class="flex items-center gap-2">
<div class="w-3 h-3 rounded-full" style="background-color: <%= colors[lang] || colors['Other'] %>;"></div>
<span class="dark:text-slate-300"><%= lang %></span>
<span class="text-slate-500 dark:text-slate-400">(<%= count %>)</span>
</div>
<% }); %>
</div>
</div>

<div class="flex flex-col gap-4 rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 p-6">
<h2 class="text-[#0d141c] dark:text-white text-lg font-semibold leading-normal">Kielitilastot</h2>
<div class="space-y-3">
<% sortedLanguages.forEach(([lang, count], index) => { %>
<div class="flex items-center justify-between p-3 rounded-lg bg-slate-50 dark:bg-slate-800">
<div class="flex items-center gap-3">
<span class="flex items-center justify-center w-8 h-8 rounded-full text-sm font-semibold" style="background-color: <%= colors[lang] || colors['Other'] %>20; color: <%= colors[lang] || colors['Other'] %>;">
<%= index + 1 %>
</span>
<span class="font-medium text-[#0d141c] dark:text-white"><%= lang %></span>
</div>
<div class="flex items-center gap-2">
<div class="w-24 bg-slate-200 dark:bg-slate-700 rounded-full h-2">
<div class="h-2 rounded-full" style="width: <%= (count / totalLangCount) * 100 %>%; background-color: <%= colors[lang] || colors['Other'] %>;"></div>
</div>
<span class="text-sm text-slate-500 dark:text-slate-400 w-12 text-right"><%= count %></span>
</div>
</div>
<% }); %>
</div>
</div>
</div>

<div class="flex flex-col gap-4 rounded-xl border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 p-6">
<div class="flex justify-between items-center">
<h2 class="text-[#0d141c] dark:text-white text-lg font-semibold leading-normal">Kaikki repositoryt</h2>
<div class="flex items-center gap-4">
<label class="flex items-center gap-2 w-72 rounded-lg bg-slate-100 dark:bg-slate-800 px-3">
<span class="material-symbols-outlined text-slate-400">search</span>
<input class="form-input w-full flex-1 resize-none overflow-hidden rounded-lg text-[#0d141c] dark:text-white focus:outline-0 focus:ring-0 border-none bg-transparent h-10 placeholder:text-slate-400 text-sm font-normal" placeholder="Hae repositoryjä..." value=""/>
</label>
<div class="flex items-center gap-2">
<span class="text-sm text-slate-500 dark:text-slate-400">Järjestä:</span>
<select class="form-select rounded-lg bg-slate-100 dark:bg-slate-800 border-none text-[#0d141c] dark:text-white text-sm focus:ring-primary focus:border-primary">
<option>Viimeksi päivitetty</option>
<option>Tähtien mukaan</option>
<option>Forkkien mukaan</option>
<option>Nimen mukaan</option>
</select>
</div>
</div>
</div>
<% if (repositories.length === 0) { %>
<div class="text-center py-12">
<span class="material-symbols-outlined text-6xl text-slate-300 dark:text-slate-600">folder_open</span>
<h3 class="text-xl font-semibold text-slate-500 dark:text-slate-400 mt-4">Ei repostoja löytynyt</h3>
<p class="text-slate-400 dark:text-slate-500 mt-2">Ei löytynyt repostoja jotka olisivat päivittyneet 180 päivän sisällä.</p>
</div>
<% } else { %>
<div class="overflow-x-auto">
<table class="w-full text-left text-sm">
<thead class="text-xs text-slate-500 dark:text-slate-400 uppercase bg-slate-50 dark:bg-slate-800">
<tr>
<th class="px-6 py-3" scope="col">Repository</th>
<th class="px-6 py-3" scope="col">Kieli</th>
<th class="px-6 py-3" scope="col">Päivitetty</th>
</tr>
</thead>
<tbody>
<% repositories.forEach(function(repo) { %>
<tr class="border-b dark:border-slate-800 hover:bg-slate-50 dark:hover:bg-slate-800/50">
<th class="px-6 py-4 font-medium text-[#0d141c] dark:text-white whitespace-nowrap" scope="row">
<a class="hover:text-primary flex items-center gap-2" href="<%= repo.html_url %>" target="_blank" rel="noopener">
<i class="fab fa-github"></i>
<%= repo.name %>
</a>
</th>
<td class="px-6 py-4 text-slate-500 dark:text-slate-400">
<% if (repo.language) { %>
<span class="inline-flex items-center gap-2 px-2 py-1 rounded-full text-xs font-medium" style="background-color: <%= getLanguageColor(repo.language) %>20; color: <%= getLanguageColor(repo.language) %>;">
<span class="w-2 h-2 rounded-full" style="background-color: <%= getLanguageColor(repo.language) %>;"></span>
<%= repo.language %>
</span>
<% } else { %>
<span class="text-slate-400">-</span>
<% } %>
</td>
<td class="px-6 py-4 text-slate-500 dark:text-slate-400">
<%= new Date(repo.updated_at).toLocaleDateString('fi-FI') %>
</td>
</tr>
<% }); %>
</tbody>
</table>
</div>
<% } %>
</div>
  </main>
</div>

    <script id="repo-data" type="application/json"><%- JSON.stringify(repositories).replace(/</g, '\\u003c') %></script>
    <script>
        // Aseta kielten värit ja lisää taulukon sorttaus
        document.addEventListener('DOMContentLoaded', function() {
            const languageDots = document.querySelectorAll('.language-dot[data-color]');
            languageDots.forEach(dot => {
                const color = dot.getAttribute('data-color');
                dot.style.backgroundColor = color;
            });

            const table = document.querySelector('.repos-table');
            const tbody = table.querySelector('tbody');
            const headers = table.querySelectorAll('thead th.sortable');
            let sortState = { key: null, dir: 'asc' };

            function compareSemver(a, b) {
                const na = (a || '').replace(/^v/i, '').split('.').map(n => parseInt(n, 10) || 0);
                const nb = (b || '').replace(/^v/i, '').split('.').map(n => parseInt(n, 10) || 0);
                for (let i = 0; i < Math.max(na.length, nb.length); i++) {
                    const da = na[i] || 0; const db = nb[i] || 0;
                    if (da !== db) return da - db;
                }
                return 0;
            }

            function getValue(repo, key) {
                return repo[key] ?? '';
            }

            function sortRows(key, type, dir) {
                const rows = Array.from(tbody.querySelectorAll('tr'));
                const repos = rows.map(row => ({ row, data: row.__repoData }));

                repos.sort((a, b) => {
                    let va = getValue(a.data, key);
                    let vb = getValue(b.data, key);
                    if (type === 'date') {
                        va = new Date(va).getTime() || 0;
                        vb = new Date(vb).getTime() || 0;
                    } else if (type === 'number') {
                        va = Number(va) || 0;
                        vb = Number(vb) || 0;
                    } else if (type === 'semver') {
                        const cmp = compareSemver(va, vb);
                        return dir === 'asc' ? cmp : -cmp;
                    } else {
                        va = (va || '').toString().toLowerCase();
                        vb = (vb || '').toString().toLowerCase();
                    }
                    if (va < vb) return dir === 'asc' ? -1 : 1;
                    if (va > vb) return dir === 'asc' ? 1 : -1;
                    return 0;
                });

                repos.forEach(({ row }) => tbody.appendChild(row));

                headers.forEach(h => h.classList.remove('sorted-asc', 'sorted-desc'));
                const active = Array.from(headers).find(h => h.dataset.key === key);
                if (active) active.classList.add(dir === 'asc' ? 'sorted-asc' : 'sorted-desc');
            }

            const repoDataEl = document.getElementById('repo-data');
            const repoData = JSON.parse(repoDataEl.textContent || '[]');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            rows.forEach((row, idx) => { row.__repoData = repoData[idx]; });

            // Search functionality
            const searchInput = document.querySelector('input[placeholder*="Hae repositoryjä"]');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    rows.forEach(row => {
                        const data = row.__repoData;
                        const repoName = data.name.toLowerCase();
                        const language = (data.language || '').toLowerCase();
                        
                        if (repoName.includes(searchTerm) || language.includes(searchTerm)) {
                            row.style.display = '';
                        } else {
                            row.style.display = 'none';
                        }
                    });
                });
            }

            headers.forEach(h => {
                h.addEventListener('click', () => {
                    const key = h.dataset.key;
                    const type = h.dataset.type || 'string';
                    let dir = 'asc';
                    if (sortState.key === key) dir = sortState.dir === 'asc' ? 'desc' : 'asc';
                    sortState = { key, dir };
                    sortRows(key, type, dir);
                });
            });
        });
    </script>

    <script>
    function refreshData() {
        const refreshBtn = document.getElementById('refresh-btn');
        const refreshStatus = document.getElementById('refresh-status');
        
        // Show loading state
        refreshBtn.classList.add('hidden');
        refreshStatus.classList.remove('hidden');
        
        // Redirect to refresh the page with refresh parameter
        window.location.href = '/languages?refresh=true';
    }
    </script>

    <%- include('components/loader') %>
</body>
</html>


