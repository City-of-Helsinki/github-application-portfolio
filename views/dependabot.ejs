<!DOCTYPE html>
<html class="light" lang="fi">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title><%= title %></title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&amp;display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#0b73da",
                        "background-light": "#f5f7f8",
                        "background-dark": "#101922",
                    },
                    fontFamily: {
                        "display": ["Inter", "sans-serif"]
                    },
                    borderRadius: {
                        "DEFAULT": "0.25rem",
                        "lg": "0.5rem",
                        "xl": "0.75rem",
                        "full": "9999px"
                    },
                },
            },
        }
    </script>
    <script>
    function refreshData() {
        const refreshBtn = document.getElementById("refresh-btn");
        const refreshStatus = document.getElementById("refresh-status");
        
        refreshBtn.classList.add("hidden");
        refreshStatus.classList.remove("hidden");
        
        const currentPath = window.location.pathname;
        window.location.href = currentPath + "?refresh=true";
    }
    </script>
    <style>
        .material-symbols-outlined {
            font-variation-settings:
            'FILL' 0,
            'wght' 400,
            'GRAD' 0,
            'opsz' 24
        }
    .sortable {
      user-select: none;
    }
    .sortable:hover {
      background-color: rgba(0, 0, 0, 0.05);
    }
    .sort-icon {
      margin-left: 0.25rem;
      font-size: 0.875rem;
      color: #94a3b8;
    }
    </style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-[#0d141c] dark:text-white">
<div class="flex min-h-screen">
<%- include("components/sidebar") %>

<main class="flex-1 overflow-y-auto">
<div class="p-8">
<!-- Header -->
<div class="flex items-center justify-between mb-8">
<div class="flex items-center gap-4">
<i class="fas fa-shield-alt text-4xl text-primary"></i>
<div>
<h1 class="text-3xl font-bold text-[#0d141c] dark:text-white">Dependabot-ilmoitukset</h1>
<p class="text-slate-500 dark:text-slate-400 mt-1">Kriittisten turvallisuusilmoitusten yleiskatsaus</p>
</div>
</div>
    <div class="flex items-center gap-3">
    <select id="team-filter" class="px-4 py-2 text-sm font-medium text-[#0d141c] dark:text-white bg-white dark:bg-slate-800 border border-slate-300 dark:border-slate-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary">
    <option value="">Kaikki tiimit</option>
    <% if (typeof teams !== 'undefined' && teams && Array.isArray(teams) && teams.length > 0) { %>
    <% teams.forEach(function(team) { %>
    <% if (team && typeof team === 'string' && team.trim()) { %>
    <option value="<%= team.trim() %>"><%= team.trim() %></option>
    <% } %>
    <% }); %>
    <% } else { %>
    <!-- Debug: teams is <%= typeof teams %>, length: <%= teams && teams.length || 0 %> -->
    <% } %>
    </select>
    <button id="refresh-btn" onclick="refreshData()" class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-primary bg-primary/10 hover:bg-primary/20 rounded-lg transition-colors">
    <span class="material-symbols-outlined text-sm">refresh</span>
    PÃ¤ivitÃ¤ tiedot
    </button>
    <div id="refresh-status" class="hidden flex items-center gap-2 px-4 py-2 text-sm font-medium text-slate-500">
    <span class="material-symbols-outlined text-sm animate-spin">sync</span>
    Ladataan...
    </div>
    </div>
</div>

<!-- Stats Cards -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
<div class="flex flex-col gap-2 rounded-xl p-6 border border-red-200 dark:border-red-900 bg-red-50 dark:bg-red-900/10">
<p class="text-base font-medium text-[#0d141c] dark:text-slate-300">KriittisiÃ¤ ilmoituksia</p>
<p class="text-3xl font-bold text-red-600 stat-total-critical"><%= stats.totalCriticalAlerts %></p>
<p class="text-sm font-medium text-red-600">Kaikki</p>
</div>
<div class="flex flex-col gap-2 rounded-xl p-6 border border-red-200 dark:border-red-900 bg-red-50 dark:bg-red-900/10">
<p class="text-base font-medium text-[#0d141c] dark:text-slate-300">Repositoryt ilmoituksilla</p>
<p class="text-3xl font-bold text-red-600 stat-repos-with-alerts"><%= stats.reposWithAlerts %></p>
<p class="text-sm font-medium text-red-600">Turvallisuusriski</p>
</div>
<div class="flex flex-col gap-2 rounded-xl p-6 border border-green-200 dark:border-green-900 bg-green-50 dark:bg-green-900/10">
<p class="text-base font-medium text-[#0d141c] dark:text-slate-300">Ilman ilmoituksia</p>
<p class="text-3xl font-bold text-green-600 stat-repos-without-alerts"><%= stats.reposWithoutAlerts %></p>
<p class="text-sm font-medium text-green-600">Turvallinen</p>
</div>
<div class="flex flex-col gap-2 rounded-xl p-6 border border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900">
<p class="text-base font-medium text-[#0d141c] dark:text-slate-300">YhteensÃ¤ repositoryt</p>
<p class="text-3xl font-bold text-[#0d141c] dark:text-white stat-total-repos"><%= stats.totalRepos %></p>
<p class="text-sm font-medium text-slate-500 dark:text-slate-400">Kaikki repot</p>
</div>
</div>

<!-- Repositories with Alerts -->
<div class="rounded-xl border border-red-200 dark:border-red-900 bg-red-50 dark:bg-red-900/10 p-6 mb-8">
<div class="flex items-center justify-between mb-4">
<div class="flex items-center gap-3">
<span class="material-symbols-outlined text-2xl text-red-600">warning</span>
<h2 class="text-xl font-semibold text-[#0d141c] dark:text-white">Repositoryt kriittisillÃ¤ ilmoituksilla</h2>
</div>
<span class="text-sm text-red-600 font-medium count-with-alerts"><%= reposWithAlerts.length %> repositoryÃ¤</span>
</div>

<div class="text-center py-12 bg-white dark:bg-slate-900 rounded-lg empty-state-with-alerts <% if (reposWithAlerts.length > 0) { %>hidden<% } %>">
<span class="material-symbols-outlined text-6xl text-green-600">check_circle</span>
<h3 class="text-xl font-semibold text-green-600 mt-4">Ei kriittisiÃ¤ ilmoituksia!</h3>
<p class="text-slate-400 dark:text-slate-500 mt-2">Kaikki repositoryt ovat turvassa.</p>
</div>
<div class="overflow-x-auto bg-white dark:bg-slate-900 rounded-lg table-with-alerts <% if (reposWithAlerts.length === 0) { %>hidden<% } %>">
<table class="w-full text-left text-sm repos-with-alerts">
<thead class="text-xs text-slate-500 dark:text-slate-400 uppercase bg-slate-50 dark:bg-slate-800">
<tr>
<th class="px-6 py-3 sortable cursor-pointer hover:bg-slate-100" scope="col" data-sort="name">Repository <span class="sort-icon">â†•</span></th>
<th class="px-6 py-3 sortable cursor-pointer hover:bg-slate-100" scope="col" data-sort="language">Kieli <span class="sort-icon">â†•</span></th>
<th class="px-6 py-3 sortable cursor-pointer hover:bg-slate-100" scope="col" data-sort="alerts">KriittisiÃ¤ ilmoituksia <span class="sort-icon">â†•</span></th>
<th class="px-6 py-3 sortable cursor-pointer hover:bg-slate-100" scope="col" data-sort="updated">PÃ¤ivitetty <span class="sort-icon">â†•</span></th>
</tr>
</thead>
<tbody>
<% reposWithAlerts.forEach(function(repo) { %>
<tr class="border-b dark:border-slate-800 hover:bg-red-50 dark:hover:bg-red-900/10">
<th class="px-6 py-4 font-medium text-[#0d141c] dark:text-white whitespace-nowrap" scope="row">
<a class="hover:text-primary flex items-center gap-2" href="<%= repo.html_url %>" target="_blank" rel="noopener">
<i class="fab fa-github"></i>
<%= repo.name %>
</a>
</th>
<td class="px-6 py-4">
<% if (repo.language) { %>
<span class="inline-flex items-center gap-2 px-2 py-1 rounded-full text-xs font-medium" style="background-color: <%= getLanguageColor(repo.language) %>20; color: <%= getLanguageColor(repo.language) %>;">
<span class="w-2 h-2 rounded-full" style="background-color: <%= getLanguageColor(repo.language) %>;"></span>
<%= repo.language %>
</span>
<% } else { %>
<span class="text-slate-400">-</span>
<% } %>
</td>
<td class="px-6 py-4">
<span class="inline-flex items-center gap-2 px-3 py-1 rounded text-xs font-bold bg-red-600 text-white">
<span class="material-symbols-outlined text-sm">warning</span>
<%= repo.dependabot_critical_count %>
</span>
</td>
<td class="px-6 py-4 text-slate-500 dark:text-slate-400">
<%= new Date(repo.updated_at).toLocaleDateString('fi-FI') %>
</td>
</tr>
<% }); %>
</tbody>
</table>
</div>
</div>

<!-- Repositories without Alerts -->
<div class="repos-without-alerts-container rounded-xl border border-green-200 dark:border-green-900 bg-green-50 dark:bg-green-900/10 p-6 <% if (reposWithoutAlerts.length === 0) { %>hidden<% } %>">
<div class="flex items-center justify-between mb-4">
<div class="flex items-center gap-3">
<span class="material-symbols-outlined text-2xl text-green-600">check_circle</span>
<h2 class="text-xl font-semibold text-[#0d141c] dark:text-white">Turvalliset repositoryt</h2>
</div>
<span class="text-sm text-green-600 font-medium count-without-alerts"><%= reposWithoutAlerts.length %> repositoryÃ¤</span>
</div>

<div class="overflow-x-auto bg-white dark:bg-slate-900 rounded-lg">
<table class="w-full text-left text-sm repos-without-alerts">
<thead class="text-xs text-slate-500 dark:text-slate-400 uppercase bg-slate-50 dark:bg-slate-800">
<tr>
<th class="px-6 py-3 sortable cursor-pointer hover:bg-slate-100" scope="col" data-sort="name">Repository <span class="sort-icon">â†•</span></th>
<th class="px-6 py-3 sortable cursor-pointer hover:bg-slate-100" scope="col" data-sort="language">Kieli <span class="sort-icon">â†•</span></th>
<th class="px-6 py-3 sortable cursor-pointer hover:bg-slate-100" scope="col" data-sort="description">Kuvaus <span class="sort-icon">â†•</span></th>
<th class="px-6 py-3 sortable cursor-pointer hover:bg-slate-100" scope="col" data-sort="updated">PÃ¤ivitetty <span class="sort-icon">â†•</span></th>
</tr>
</thead>
<tbody>
<% reposWithoutAlerts.forEach(function(repo) { %>
<tr class="border-b dark:border-slate-800 hover:bg-green-50 dark:hover:bg-green-900/10">
<th class="px-6 py-4 font-medium text-[#0d141c] dark:text-white whitespace-nowrap" scope="row">
<a class="hover:text-primary flex items-center gap-2" href="<%= repo.html_url %>" target="_blank" rel="noopener">
<i class="fab fa-github"></i>
<%= repo.name %>
</a>
</th>
<td class="px-6 py-4">
<% if (repo.language) { %>
<span class="inline-flex items-center gap-2 px-2 py-1 rounded-full text-xs font-medium" style="background-color: <%= getLanguageColor(repo.language) %>20; color: <%= getLanguageColor(repo.language) %>;">
<span class="w-2 h-2 rounded-full" style="background-color: <%= getLanguageColor(repo.language) %>;"></span>
<%= repo.language %>
</span>
<% } else { %>
<span class="text-slate-400">-</span>
<% } %>
</td>
<td class="px-6 py-4 text-slate-500 dark:text-slate-400">
<%= repo.description || '-' %>
</td>
<td class="px-6 py-4 text-slate-500 dark:text-slate-400">
<%= new Date(repo.updated_at).toLocaleDateString('fi-FI') %>
</td>
</tr>
<% }); %>
</tbody>
</table>
</div>
</div>
</main>
</div>

<script>
// Store original repository data
const originalReposWithAlerts = <%- JSON.stringify(typeof reposWithAlerts !== 'undefined' && reposWithAlerts ? reposWithAlerts : []) %>;
const originalReposWithoutAlerts = <%- JSON.stringify(typeof reposWithoutAlerts !== 'undefined' && reposWithoutAlerts ? reposWithoutAlerts : []) %>;

// Get language color helper (must be defined before use)
function getLanguageColor(language) {
  const colors = {
    'JavaScript': '#f7df1e',
    'TypeScript': '#3178c6',
    'Python': '#3776ab',
    'Java': '#ed8b00',
    'Go': '#00add8',
    'Rust': '#000000',
    'PHP': '#777bb4',
    'Ruby': '#cc342d',
    'C++': '#00599c',
    'C': '#a8b9cc',
    'C#': '#239120',
    'Swift': '#fa7343',
    'Kotlin': '#7f52ff',
    'Dart': '#0175c2',
    'HTML': '#e34c26',
    'CSS': '#1572b6',
    'Shell': '#89e051',
    'Dockerfile': '#384d54'
  };
  return colors[language] || '#94a3b8';
}

// Get team from repository (check all_teams array or team field)
function getRepoTeams(repo) {
  const teams = [];
  
  // Parse all_teams if it's a string (shouldn't happen but handle it)
  let allTeams = repo.all_teams;
  if (typeof allTeams === 'string') {
    try {
      allTeams = JSON.parse(allTeams);
    } catch (e) {
      allTeams = [];
    }
  }
  
  if (allTeams && Array.isArray(allTeams) && allTeams.length > 0) {
    teams.push(...allTeams.filter(t => t && typeof t === 'string' && t.trim()));
  } else if (repo.team && typeof repo.team === 'string' && repo.team.trim()) {
    teams.push(repo.team.trim());
  }
  
  return teams;
}

// Check if repository belongs to selected team
function belongsToTeam(repo, selectedTeam) {
  if (!selectedTeam) return true; // Show all if no filter
  const repoTeams = getRepoTeams(repo);
  const matches = repoTeams.some(team => team === selectedTeam || team.trim() === selectedTeam.trim());
  return matches;
}

// Filter repositories by team
function filterRepositoriesByTeam(selectedTeam) {
  const filteredWithAlerts = originalReposWithAlerts.filter(repo => belongsToTeam(repo, selectedTeam));
  const filteredWithoutAlerts = originalReposWithoutAlerts.filter(repo => belongsToTeam(repo, selectedTeam));
  
  console.log(`ðŸ” FiltterÃ¶inti tiimillÃ¤ "${selectedTeam}": ${filteredWithAlerts.length} ilmoituksilla, ${filteredWithoutAlerts.length} ilman ilmoituksia`);
  if (selectedTeam && filteredWithAlerts.length === 0 && filteredWithoutAlerts.length === 0) {
    // Debug: check first repo's teams
    if (originalReposWithAlerts.length > 0) {
      const firstRepo = originalReposWithAlerts[0];
      const firstRepoTeams = getRepoTeams(firstRepo);
      console.log(`ðŸ” Debug: EnsimmÃ¤isen repon tiimit: ${JSON.stringify(firstRepoTeams)}, etsitty: "${selectedTeam}"`);
    }
  }
  
  return { filteredWithAlerts, filteredWithoutAlerts };
}

// Update table with filtered data
function updateTables(filteredWithAlerts, filteredWithoutAlerts) {
  console.log(`ðŸ” updateTables kutsuttu: ${filteredWithAlerts.length} ilmoituksilla, ${filteredWithoutAlerts.length} ilman`);
  
  // Update "with alerts" table
  const withAlertsTbody = document.querySelector('.repos-with-alerts tbody');
  if (!withAlertsTbody) {
    console.error('ðŸ” Virhe: .repos-with-alerts tbody ei lÃ¶ydy!');
    return;
  }
  
  withAlertsTbody.innerHTML = '';
  filteredWithAlerts.forEach(repo => {
      const row = document.createElement('tr');
      row.className = 'border-b dark:border-slate-800 hover:bg-red-50 dark:hover:bg-red-900/10';
      
      // Create cells safely
      const th = document.createElement('th');
      th.className = 'px-6 py-4 font-medium text-[#0d141c] dark:text-white whitespace-nowrap';
      th.setAttribute('scope', 'row');
      const link = document.createElement('a');
      link.className = 'hover:text-primary flex items-center gap-2';
      link.href = repo.html_url || '#';
      link.target = '_blank';
      link.rel = 'noopener';
      const icon = document.createElement('i');
      icon.className = 'fab fa-github';
      link.appendChild(icon);
      link.appendChild(document.createTextNode(repo.name || ''));
      th.appendChild(link);
      
      const td1 = document.createElement('td');
      td1.className = 'px-6 py-4';
      if (repo.language) {
        const langSpan = document.createElement('span');
        langSpan.className = 'inline-flex items-center gap-2 px-2 py-1 rounded-full text-xs font-medium';
        const color = getLanguageColor(repo.language);
        langSpan.style.backgroundColor = color + '20';
        langSpan.style.color = color;
        const dot = document.createElement('span');
        dot.className = 'w-2 h-2 rounded-full';
        dot.style.backgroundColor = color;
        langSpan.appendChild(dot);
        langSpan.appendChild(document.createTextNode(repo.language));
        td1.appendChild(langSpan);
      } else {
        const dash = document.createElement('span');
        dash.className = 'text-slate-400';
        dash.textContent = '-';
        td1.appendChild(dash);
      }
      
      const td2 = document.createElement('td');
      td2.className = 'px-6 py-4';
      const alertSpan = document.createElement('span');
      alertSpan.className = 'inline-flex items-center gap-2 px-3 py-1 rounded text-xs font-bold bg-red-600 text-white';
      const warningIcon = document.createElement('span');
      warningIcon.className = 'material-symbols-outlined text-sm';
      warningIcon.textContent = 'warning';
      alertSpan.appendChild(warningIcon);
      alertSpan.appendChild(document.createTextNode(String(repo.dependabot_critical_count || 0)));
      td2.appendChild(alertSpan);
      
      const td3 = document.createElement('td');
      td3.className = 'px-6 py-4 text-slate-500 dark:text-slate-400';
      td3.textContent = repo.updated_at ? new Date(repo.updated_at).toLocaleDateString('fi-FI') : '-';
      
      row.appendChild(th);
      row.appendChild(td1);
      row.appendChild(td2);
      row.appendChild(td3);
      withAlertsTbody.appendChild(row);
    });
    
    // Show/hide empty state
    const emptyState = document.querySelector('.empty-state-with-alerts');
    const tableContainer = document.querySelector('.table-with-alerts');
    if (filteredWithAlerts.length === 0) {
      if (emptyState) emptyState.classList.remove('hidden');
      if (tableContainer) tableContainer.classList.add('hidden');
    } else {
      if (emptyState) emptyState.classList.add('hidden');
      if (tableContainer) tableContainer.classList.remove('hidden');
    }
    
    // Update count
    const countElement = document.querySelector('.count-with-alerts');
    if (countElement) {
      countElement.textContent = `${filteredWithAlerts.length} repositoryÃ¤`;
    }
  
  // Update "without alerts" table
  const withoutAlertsContainer = document.querySelector('.repos-without-alerts-container');
  const withoutAlertsTbody = document.querySelector('.repos-without-alerts tbody');
  if (!withoutAlertsTbody) {
    console.error('ðŸ” Virhe: .repos-without-alerts tbody ei lÃ¶ydy!');
    return;
  }
  
  withoutAlertsTbody.innerHTML = '';
  filteredWithoutAlerts.forEach(repo => {
      const row = document.createElement('tr');
      row.className = 'border-b dark:border-slate-800 hover:bg-green-50 dark:hover:bg-green-900/10';
      
      // Create cells safely
      const th = document.createElement('th');
      th.className = 'px-6 py-4 font-medium text-[#0d141c] dark:text-white whitespace-nowrap';
      th.setAttribute('scope', 'row');
      const link = document.createElement('a');
      link.className = 'hover:text-primary flex items-center gap-2';
      link.href = repo.html_url || '#';
      link.target = '_blank';
      link.rel = 'noopener';
      const icon = document.createElement('i');
      icon.className = 'fab fa-github';
      link.appendChild(icon);
      link.appendChild(document.createTextNode(repo.name || ''));
      th.appendChild(link);
      
      const td1 = document.createElement('td');
      td1.className = 'px-6 py-4';
      if (repo.language) {
        const langSpan = document.createElement('span');
        langSpan.className = 'inline-flex items-center gap-2 px-2 py-1 rounded-full text-xs font-medium';
        const color = getLanguageColor(repo.language);
        langSpan.style.backgroundColor = color + '20';
        langSpan.style.color = color;
        const dot = document.createElement('span');
        dot.className = 'w-2 h-2 rounded-full';
        dot.style.backgroundColor = color;
        langSpan.appendChild(dot);
        langSpan.appendChild(document.createTextNode(repo.language));
        td1.appendChild(langSpan);
      } else {
        const dash = document.createElement('span');
        dash.className = 'text-slate-400';
        dash.textContent = '-';
        td1.appendChild(dash);
      }
      
      const td2 = document.createElement('td');
      td2.className = 'px-6 py-4 text-slate-500 dark:text-slate-400';
      td2.textContent = repo.description || '-';
      
      const td3 = document.createElement('td');
      td3.className = 'px-6 py-4 text-slate-500 dark:text-slate-400';
      td3.textContent = repo.updated_at ? new Date(repo.updated_at).toLocaleDateString('fi-FI') : '-';
      
      row.appendChild(th);
      row.appendChild(td1);
      row.appendChild(td2);
      row.appendChild(td3);
      withoutAlertsTbody.appendChild(row);
    });
    
    // Update count
    const countElement = document.querySelector('.count-without-alerts');
    if (countElement) {
      countElement.textContent = `${filteredWithoutAlerts.length} repositoryÃ¤`;
    }
    
    // Show/hide "without alerts" container
    if (withoutAlertsContainer) {
      if (filteredWithoutAlerts.length === 0) {
        withoutAlertsContainer.classList.add('hidden');
      } else {
        withoutAlertsContainer.classList.remove('hidden');
      }
    }
  
  // Update stats
  const totalCritical = filteredWithAlerts.reduce((sum, repo) => sum + (repo.dependabot_critical_count || 0), 0);
  const totalRepos = filteredWithAlerts.length + filteredWithoutAlerts.length;
  
  const statTotalCritical = document.querySelector('.stat-total-critical');
  const statReposWithAlerts = document.querySelector('.stat-repos-with-alerts');
  const statReposWithoutAlerts = document.querySelector('.stat-repos-without-alerts');
  const statTotalRepos = document.querySelector('.stat-total-repos');
  
  if (statTotalCritical) statTotalCritical.textContent = totalCritical;
  if (statReposWithAlerts) statReposWithAlerts.textContent = filteredWithAlerts.length;
  if (statReposWithoutAlerts) statReposWithoutAlerts.textContent = filteredWithoutAlerts.length;
  if (statTotalRepos) statTotalRepos.textContent = totalRepos;
}

document.addEventListener('DOMContentLoaded', function() {
  // Restore selected team from localStorage
  const savedTeam = localStorage.getItem('dependabot-filter-team');
  const teamFilter = document.getElementById('team-filter');
  if (teamFilter && savedTeam) {
    teamFilter.value = savedTeam;
  }
  
  // Initial filter application
  const selectedTeam = teamFilter ? teamFilter.value : '';
  const { filteredWithAlerts, filteredWithoutAlerts } = filterRepositoriesByTeam(selectedTeam);
  updateTables(filteredWithAlerts, filteredWithoutAlerts);
  
  // Add event listener for team filter
  if (teamFilter) {
    teamFilter.addEventListener('change', function() {
      const selectedTeam = this.value;
      console.log(`ðŸ” Tiimi-valinta muuttui: "${selectedTeam}"`);
      localStorage.setItem('dependabot-filter-team', selectedTeam);
      const { filteredWithAlerts, filteredWithoutAlerts } = filterRepositoriesByTeam(selectedTeam);
      console.log(`ðŸ” PÃ¤ivitetÃ¤Ã¤n taulukot: ${filteredWithAlerts.length} ja ${filteredWithoutAlerts.length} repositoryÃ¤`);
      updateTables(filteredWithAlerts, filteredWithoutAlerts);
    });
  }
  
  const tables = document.querySelectorAll('table');
  
  tables.forEach(table => {
    const headers = table.querySelectorAll('th.sortable');
    const tbody = table.querySelector('tbody');
    let currentSort = { column: null, ascending: true };
    
    headers.forEach(header => {
      header.addEventListener('click', function() {
        const sortKey = this.getAttribute('data-sort');
        const isAscending = currentSort.column === sortKey ? !currentSort.ascending : true;
        
        // Update sort icons
        headers.forEach(h => {
          const icon = h.querySelector('.sort-icon');
          if (icon) icon.textContent = 'â†•';
        });
        const icon = this.querySelector('.sort-icon');
        if (icon) icon.textContent = isAscending ? 'â†‘' : 'â†“';
        
        // Sort rows
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const sortedRows = rows.sort((a, b) => {
          let aVal, bVal;
          
          const getCellValue = (row, idx) => {
            const cells = row.querySelectorAll('td');
            if (idx < cells.length && idx >= 0) {
              return cells[idx].textContent.trim();
            }
            return '';
          };
          
          // Get cell values based on sort key
          if (sortKey === 'name') {
            aVal = a.querySelector('th a').textContent.trim().toLowerCase();
            bVal = b.querySelector('th a').textContent.trim().toLowerCase();
          } else if (sortKey === 'language') {
            // Language is the first td (index 0)
            aVal = getCellValue(a, 0).toLowerCase();
            bVal = getCellValue(b, 0).toLowerCase();
          } else if (sortKey === 'alerts') {
            // Alerts is the second td (index 1) - contains the number in a span
            const aCell = a.querySelectorAll('td')[1];
            const bCell = b.querySelectorAll('td')[1];
            // Get the span's text content or the cell's text content
            const aSpan = aCell ? aCell.querySelector('span') : null;
            const bSpan = bCell ? bCell.querySelector('span') : null;
            aVal = aSpan ? parseInt(aSpan.textContent.trim()) : 0;
            bVal = bSpan ? parseInt(bSpan.textContent.trim()) : 0;
          } else if (sortKey === 'updated') {
            // Updated is the last td (index 2 for "with alerts" table, index 3 for "without alerts")
            const aCells = a.querySelectorAll('td');
            const bCells = b.querySelectorAll('td');
            const aLastIdx = aCells.length - 1;
            const bLastIdx = bCells.length - 1;
            aVal = getCellValue(a, aLastIdx);
            bVal = getCellValue(b, bLastIdx);
            // Parse Finnish date format (dd.mm.yyyy)
            const aParts = aVal.split('.');
            const bParts = bVal.split('.');
            aVal = new Date(aParts[2], aParts[1] - 1, aParts[0]);
            bVal = new Date(bParts[2], bParts[1] - 1, bParts[0]);
          } else if (sortKey === 'description') {
            // Description is the second td (index 1) for "without alerts" table
            aVal = getCellValue(a, 1).toLowerCase();
            bVal = getCellValue(b, 1).toLowerCase();
          } else {
            // Fallback: try to get by index
            const cells = row.querySelectorAll('td');
            const idx = Array.from(table.querySelector('thead tr').children).findIndex(
              th => th.getAttribute('data-sort') === sortKey
            ) - 1; // Subtract 1 because first column is <th>, not <td>
            aVal = getCellValue(a, idx).toLowerCase();
            bVal = getCellValue(b, idx).toLowerCase();
          }
          
          if (aVal === '-') return 1;
          if (bVal === '-') return -1;
          
          if (aVal < bVal) return isAscending ? -1 : 1;
          if (aVal > bVal) return isAscending ? 1 : -1;
          return 0;
        });
        
        // Re-append sorted rows
        sortedRows.forEach(row => tbody.appendChild(row));
        
        currentSort = { column: sortKey, ascending: isAscending };
      });
    });
  });
});
</script>

</body>
</html>
